<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•½ë™í•™ AUC ì‹œë®¬ë ˆì´ì…˜</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
        }

        .controls {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            height: fit-content;
        }

        .control-group {
            margin-bottom: 25px;
        }

        .control-group h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
            font-size: 0.95em;
        }

        .input-with-value {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 5px;
            background: #d3d3d3;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .value-display {
            min-width: 80px;
            background: white;
            padding: 5px 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        input[type="radio"] {
            cursor: pointer;
        }

        .graph-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .results {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 5px solid #667eea;
        }

        .results h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .result-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .result-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .result-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .result-unit {
            font-size: 0.9em;
            color: #999;
        }

        .formula {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #ffc107;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
        }

        #myChart {
            max-height: 500px;
        }

        .info-box {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
            font-size: 0.9em;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’Š ì•½ë™í•™ AUC ì‹œë®¬ë ˆì´ì…˜</h1>
        <p class="subtitle">í˜ˆì¤‘ ë†ë„-ì‹œê°„ ê³¡ì„ ê³¼ ì ë¶„ì„ í†µí•œ ìƒì²´ì´ìš©ë¥  í‰ê°€</p>

        <div class="main-content">
            <div class="controls">
                <div class="control-group">
                    <h3>íˆ¬ì—¬ ë°©ë²•</h3>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="route" value="iv" checked>
                            ì •ë§¥ ì£¼ì‚¬ IV
                        </label>
                        <label>
                            <input type="radio" name="route" value="oral">
                            ê²½êµ¬ íˆ¬ì—¬ PO
                        </label>
                    </div>
                </div>

                <div class="control-group">
                    <h3>ê¸°ë³¸ íŒŒë¼ë¯¸í„°</h3>
                    
                    <div class="input-group">
                        <label>íˆ¬ì—¬ëŸ‰ D (mg)</label>
                        <div class="input-with-value">
                            <input type="range" id="dose" min="10" max="500" value="100" step="10">
                            <span class="value-display" id="doseValue">100 mg</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>ë¶„í¬ ìš©ì  V<sub>d</sub> (L)</label>
                        <div class="input-with-value">
                            <input type="range" id="vd" min="10" max="100" value="50" step="5">
                            <span class="value-display" id="vdValue">50 L</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>ì œê±° ì†ë„ ìƒìˆ˜ k<sub>el</sub> (1/h)</label>
                        <div class="input-with-value">
                            <input type="range" id="kel" min="0.05" max="1.0" value="0.2" step="0.05">
                            <span class="value-display" id="kelValue">0.20 /h</span>
                        </div>
                    </div>

                    <div class="input-group" id="kaGroup" style="display: none;">
                        <label>í¡ìˆ˜ ì†ë„ ìƒìˆ˜ k<sub>a</sub> (1/h)</label>
                        <div class="input-with-value">
                            <input type="range" id="ka" min="0.1" max="2.0" value="0.8" step="0.1">
                            <span class="value-display" id="kaValue">0.80 /h</span>
                        </div>
                    </div>

                    <div class="input-group" id="fGroup" style="display: none;">
                        <label>ìƒì²´ì´ìš©ë¥  F</label>
                        <div class="input-with-value">
                            <input type="range" id="bioavail" min="0.1" max="1.0" value="0.7" step="0.05">
                            <span class="value-display" id="bioavailValue">0.70</span>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>ë‹¤íšŒ íˆ¬ì—¬ ì„¤ì •</h3>
                    
                    <div class="input-group">
                        <label>íˆ¬ì—¬ ê°„ê²© Ï„ (h)</label>
                        <div class="input-with-value">
                            <input type="range" id="tau" min="2" max="24" value="8" step="2">
                            <span class="value-display" id="tauValue">8 h</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>íˆ¬ì—¬ íšŸìˆ˜</label>
                        <div class="input-with-value">
                            <input type="range" id="doses" min="1" max="10" value="1" step="1">
                            <span class="value-display" id="dosesValue">1íšŒ</span>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <div class="info-box">
                    <strong>â„¹ï¸ ì‹¤ì‹œê°„ ì‹œë®¬ë ˆì´ì…˜</strong><br>
                    â€¢ íŒŒë¼ë¯¸í„°ë¥¼ ì¡°ì ˆí•˜ë©´ ê·¸ë˜í”„ê°€ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤<br>
                    â€¢ ì¶•ì´ ê³ ì •ë˜ì–´ ìˆì–´ ë³€í™”ë¥¼ ëª…í™•íˆ ë¹„êµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>
                    â€¢ AUCëŠ” ì‚¬ë‹¤ë¦¬ê¼´ ê³µì‹ìœ¼ë¡œ ìˆ˜ì¹˜ ì ë¶„ë©ë‹ˆë‹¤
                </div>

                <div class="graph-container">
                    <canvas id="myChart"></canvas>
                </div>

                <div class="results" id="results">
                    <h3>ğŸ“Š ê³„ì‚° ê²°ê³¼</h3>
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="result-label">AUC (ìˆ˜ì¹˜ ì ë¶„)</div>
                            <div class="result-value" id="aucNumeric">0</div>
                            <div class="result-unit">mgÂ·h/L</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">AUC (ì´ë¡ ê°’)</div>
                            <div class="result-value" id="aucTheory">0</div>
                            <div class="result-unit">mgÂ·h/L</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">í´ë¦¬ì–´ëŸ°ìŠ¤ CL</div>
                            <div class="result-value" id="clearance">0</div>
                            <div class="result-unit">L/h</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">ë°˜ê°ê¸° t<sub>1/2</sub></div>
                            <div class="result-value" id="halflife">0</div>
                            <div class="result-unit">h</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">C<sub>max</sub></div>
                            <div class="result-value" id="cmax">0</div>
                            <div class="result-unit">mg/L</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">T<sub>max</sub></div>
                            <div class="result-value" id="tmax">0</div>
                            <div class="result-unit">h</div>
                        </div>
                    </div>
                    <div class="formula" id="formulaDisplay"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let myChart = null;

        // íˆ¬ì—¬ ê²½ë¡œ ë³€ê²½ ì‹œ íŒŒë¼ë¯¸í„° í‘œì‹œ ì¡°ì ˆ ë° ì¦‰ì‹œ ì—…ë°ì´íŠ¸
        document.querySelectorAll('input[name="route"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const isOral = this.value === 'oral';
                document.getElementById('kaGroup').style.display = isOral ? 'block' : 'none';
                document.getElementById('fGroup').style.display = isOral ? 'block' : 'none';
                runSimulation();
            });
        });

        // ìŠ¬ë¼ì´ë” ê°’ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ë° ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰
        function setupSlider(sliderId, displayId, unit, decimals = 0) {
            const slider = document.getElementById(sliderId);
            const display = document.getElementById(displayId);
            slider.addEventListener('input', function() {
                const value = parseFloat(this.value);
                const formatted = decimals > 0 ? value.toFixed(decimals) : value;
                display.textContent = formatted + ' ' + unit;
                runSimulation();
            });
        }

        setupSlider('dose', 'doseValue', 'mg', 0);
        setupSlider('vd', 'vdValue', 'L', 0);
        setupSlider('kel', 'kelValue', '/h', 2);
        setupSlider('ka', 'kaValue', '/h', 2);
        setupSlider('bioavail', 'bioavailValue', '', 2);
        setupSlider('tau', 'tauValue', 'h', 0);
        
        document.getElementById('doses').addEventListener('input', function() {
            document.getElementById('dosesValue').textContent = this.value + 'íšŒ';
            runSimulation();
        });

        // ì •ë§¥ ì£¼ì‚¬ ë†ë„ í•¨ìˆ˜
        function concentrationIV(t, C0, kel) {
            return C0 * Math.exp(-kel * t);
        }

        // ê²½êµ¬ íˆ¬ì—¬ ë†ë„ í•¨ìˆ˜ (Bateman function)
        function concentrationOral(t, D, Vd, F, ka, kel) {
            const factor = (F * D * ka) / (Vd * (ka - kel));
            return factor * (Math.exp(-kel * t) - Math.exp(-ka * t));
        }

        // ì‚¬ë‹¤ë¦¬ê¼´ ê³µì‹ì„ ì´ìš©í•œ AUC ê³„ì‚°
        function calculateAUC(timePoints, concentrations) {
            let auc = 0;
            for (let i = 0; i < timePoints.length - 1; i++) {
                const dt = timePoints[i + 1] - timePoints[i];
                const avgC = (concentrations[i] + concentrations[i + 1]) / 2;
                auc += avgC * dt;
            }
            // ê¼¬ë¦¬ ë¶€ë¶„ ì™¸ì‚½ (ë§ˆì§€ë§‰ ì¸¡ì •ì  ì´í›„)
            const lastC = concentrations[concentrations.length - 1];
            const kel = parseFloat(document.getElementById('kel').value);
            auc += lastC / kel;
            
            return auc;
        }

        function runSimulation() {
            // íŒŒë¼ë¯¸í„° ì½ê¸°
            const route = document.querySelector('input[name="route"]:checked').value;
            const D = parseFloat(document.getElementById('dose').value);
            const Vd = parseFloat(document.getElementById('vd').value);
            const kel = parseFloat(document.getElementById('kel').value);
            const ka = parseFloat(document.getElementById('ka').value);
            const F = parseFloat(document.getElementById('bioavail').value);
            const tau = parseFloat(document.getElementById('tau').value);
            const nDoses = parseInt(document.getElementById('doses').value);

            // ì‹œê°„ ë°°ì—´ ìƒì„±
            const totalTime = 72; // ê³ ì •ëœ ì‹œê°„ ë²”ìœ„ 72ì‹œê°„
            const timePoints = [];
            const dt = 0.1; // ê³„ì‚°ìš© ë¯¸ì„¸ ê°„ê²©
            for (let t = 0; t <= totalTime; t += dt) {
                timePoints.push(parseFloat(t.toFixed(1)));
            }

            // ë†ë„ ê³„ì‚°
            let concentrations = new Array(timePoints.length).fill(0);
            
            if (route === 'iv') {
                const C0 = D / Vd;
                for (let dose = 0; dose < nDoses; dose++) {
                    const doseTime = dose * tau;
                    for (let i = 0; i < timePoints.length; i++) {
                        const t = timePoints[i];
                        if (t >= doseTime) {
                            concentrations[i] += concentrationIV(t - doseTime, C0, kel);
                        }
                    }
                }
            } else {
                for (let dose = 0; dose < nDoses; dose++) {
                    const doseTime = dose * tau;
                    for (let i = 0; i < timePoints.length; i++) {
                        const t = timePoints[i];
                        if (t >= doseTime) {
                            concentrations[i] += concentrationOral(t - doseTime, D, Vd, F, ka, kel);
                        }
                    }
                }
            }

            // Cmax, Tmax ê³„ì‚°
            let cmax = Math.max(...concentrations);
            let tmaxIndex = concentrations.indexOf(cmax);
            let tmax = timePoints[tmaxIndex];

            // AUC ê³„ì‚°
            const aucNumeric = calculateAUC(timePoints, concentrations);
            const effectiveDose = route === 'iv' ? D : D * F;
            const CL = kel * Vd;
            const aucTheory = effectiveDose / CL;
            const halflife = Math.log(2) / kel;

            // ê²°ê³¼ í‘œì‹œ
            document.getElementById('aucNumeric').textContent = aucNumeric.toFixed(1);
            document.getElementById('aucTheory').textContent = aucTheory.toFixed(1);
            document.getElementById('clearance').textContent = CL.toFixed(1);
            document.getElementById('halflife').textContent = halflife.toFixed(1);
            document.getElementById('cmax').textContent = cmax.toFixed(2);
            document.getElementById('tmax').textContent = tmax.toFixed(1);

            // ìˆ˜ì‹ í‘œì‹œ
            let formulaText = '';
            if (route === 'iv') {
                formulaText = `C(t) = ${(D/Vd).toFixed(2)} Ã— e^(-${kel.toFixed(2)}t)<br>`;
                formulaText += `AUC = D / CL = ${D} / ${CL.toFixed(1)} = ${aucTheory.toFixed(1)} mgÂ·h/L`;
            } else {
                const factor = (F * D * ka) / (Vd * (ka - kel));
                formulaText = `C(t) = ${factor.toFixed(2)} Ã— (e^(-${kel.toFixed(2)}t) - e^(-${ka.toFixed(2)}t))<br>`;
                formulaText += `AUC = FÂ·D / CL = ${F.toFixed(2)}Ã—${D} / ${CL.toFixed(1)} = ${aucTheory.toFixed(1)} mgÂ·h/L`;
            }
            document.getElementById('formulaDisplay').innerHTML = formulaText;

            // ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
            drawChart(timePoints, concentrations, route, nDoses, tau);
        }

        function drawChart(timePoints, concentrations, route, nDoses, tau) {
            const ctx = document.getElementById('myChart').getContext('2d');
            
            if (myChart) {
                myChart.destroy();
            }

            // ê·¸ë˜í”„ í‘œì‹œìš© ë°ì´í„° ìƒ˜í”Œë§ (ì •ìˆ˜ ì‹œê°„ë§Œ)
            const displayTimePoints = [];
            const displayConcentrations = [];
            
            for (let i = 0; i < timePoints.length; i++) {
                if (Math.abs(timePoints[i] - Math.round(timePoints[i])) < 0.05) {
                    displayTimePoints.push(Math.round(timePoints[i]));
                    displayConcentrations.push(concentrations[i]);
                }
            }

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: displayTimePoints,
                    datasets: [{
                        label: 'í˜ˆì¤‘ ë†ë„ C(t)',
                        data: displayConcentrations,
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    animation: false, // ì• ë‹ˆë©”ì´ì…˜ ì™„ì „íˆ ì œê±°
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: `í˜ˆì¤‘ ë†ë„-ì‹œê°„ ê³¡ì„  (${route === 'iv' ? 'ì •ë§¥ ì£¼ì‚¬ IV' : 'ê²½êµ¬ íˆ¬ì—¬ PO'}, ${nDoses}íšŒ íˆ¬ì—¬)`,
                            font: {
                                size: 18
                            }
                        }
                    },
                    scales: {
                        x: {
                            min: 0,
                            max: 72, // Xì¶• ê³ ì • 0~72ì‹œê°„
                            title: {
                                display: true,
                                text: 'ì‹œê°„ (h)',
                                font: {
                                    size: 14
                                }
                            },
                            ticks: {
                                stepSize: 8,
                                callback: function(value) {
                                    return value;
                                }
                            }
                        },
                        y: {
                            min: 0,
                            max: 12, // Yì¶• ê³ ì • 0~12 mg/L
                            title: {
                                display: true,
                                text: 'ë†ë„ (mg/L)',
                                font: {
                                    size: 14
                                }
                            },
                            ticks: {
                                stepSize: 2,
                                callback: function(value) {
                                    return value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰
        window.onload = function() {
            runSimulation();
        };
    </script>
</body>
</html>